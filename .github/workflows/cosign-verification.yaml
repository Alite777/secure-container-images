name: cosign-verification
on:
  pull_request:
    paths:
      - 'cd/helm-charts/**' # Only run on changes to helm charts
  # Allows manual triggering and disablement of workflow
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      # declare variables "charts" and "has-charts" to reference them later
      # steps.get-charts references the set id of the first step "Get changed charts"
      charts: ${{ steps.get-charts.outputs.charts }}
      has-charts: ${{ steps.get-charts.outputs.has-charts }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history to compare changes
          
      - name: Get changed charts
        id: get-charts
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual runs, scan all charts
            CHARTS=$(find cd/helm-charts -maxdepth 1 -mindepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            # For PRs, only scan changed charts
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
            CHARTS=$(echo "$CHANGED_FILES" | grep '^cd/helm-charts/' | cut -d'/' -f3 | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi
          
          echo "charts=${CHARTS}" >> $GITHUB_OUTPUT
          
          # Check if we have any charts to scan
          if [ "$CHARTS" = "[]" ] || [ -z "$CHARTS" ]; then
            echo "has-charts=false" >> $GITHUB_OUTPUT
            echo "No charts to scan"
          else
            echo "has-charts=true" >> $GITHUB_OUTPUT
            echo "Charts to scan: ${CHARTS}"
          fi
  
  cosign:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-charts == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chart: ${{ fromJson(needs.detect-changes.outputs.charts) }}
      fail-fast: false # Continue verifying other charts even if one fails
    
    steps:
      - uses: actions/checkout@v4 # Clones the repository of the workflow into the filesystem of the runner (to ./)

      - name: Install yq
        uses: frenck/action-setup-yq@v1 # Installs yq, a tool that can read yaml files

      - name: Read image from values.yaml
        id: image
        run: |
          VALUES_FILE="cd/helm-charts/${{ matrix.chart }}/values.yaml"
          REGISTRY=$(yq e '.image.registry' "$VALUES_FILE")
          REPO=$(yq e '.image.repository' "$VALUES_FILE")
          TAG=$(yq e '.image.tag' "$VALUES_FILE")
          SHA=$(yq e '.image.sha' "$VALUES_FILE")
          DIGEST=$(yq e '.image.digest' "$VALUES_FILE")
          
          # Fallback to 'latest' if tag is empty
          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            TAG="latest"
          fi
          
          # Build full image reference with registry if present
          if [ -n "$REGISTRY" ] && [ "$REGISTRY" != "null" ]; then
            IMAGE="${REGISTRY}/${REPO}:${TAG}"
          else
            IMAGE="${REPO}:${TAG}"
          fi
          
          # Add SHA or digest if present
          if [ -n "$SHA" ] && [ "$SHA" != "null" ]; then
            IMAGE="${IMAGE}@sha256:${SHA}"
          elif [ -n "$DIGEST" ] && [ "$DIGEST" != "null" ]; then
            # If digest already contains sha256:, use as-is, otherwise add prefix
            if [[ "$DIGEST" == sha256:* ]]; then
              IMAGE="${IMAGE}@${DIGEST}"
            else
              IMAGE="${IMAGE}@sha256:${DIGEST}"
            fi
          fi
          
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "Scanning image: ${IMAGE}"

      - name: Install cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Verify cosign installation
        run: |
          cosign version

      - name: Verify image signature with cosign
        id: cosign-verify
        continue-on-error: true
        run: |
          IMAGE="${{ steps.image.outputs.image }}"
          echo "Verifying signature for: ${IMAGE}"
          
          # Extract digest if present for better error reporting
          if [[ "$IMAGE" == *"@"* ]]; then
            DIGEST="${IMAGE##*@}"
            echo "Using digest: ${DIGEST}"
          fi
          echo "skipped digest extraction"

          # Attempt keyless verification with Sigstore
          COSIGN_OUTPUT=$(cosign verify "${IMAGE}" --certificate-oidc-issuer-regexp=".*" --certificate-identity-regexp=".*")
          echo "$COSIGN_OUTPUT"
          echo "attempted to read output"

          if echo "$COSIGN_OUTPUT" | grep -q "The following checks were performed"; then
            echo "Signature verified with Sigstore keyless signing"
            echo "verified=true" >> $GITHUB_OUTPUT
          else
            echo "Signature verification failed"
            echo "Cosign output: $COSIGN_OUTPUT"
            echo "verified=false" >> $GITHUB_OUTPUT
          fi

      - name: Report verification result
        if: always()
        run: |
          IMAGE="${{ steps.image.outputs.image }}"
          VERIFIED="${{ steps.cosign-verify.outputs.verified }}"
          
          if [ "$VERIFIED" = "true" ]; then
            echo "${{ matrix.chart }}: Image signature verified"
          else
            echo "${{ matrix.chart }}: Image is not signed or cannot be verified"
            exit 1
          fi

